# 腾讯分分彩公式搜索自动化工具

## 项目简介

本项目是一个自动化工具，用于搜索腾讯分分彩的公式并分析结果。该工具能够自动启动目标应用，导航到公式搜索界面，设置搜索参数，执行搜索并提取结果，然后将搜索结果与历史数据进行对比分析。

## 功能特点

- 自动启动和导航目标应用
- 自动配置搜索参数
- 执行公式搜索并提取结果
- 获取历史开奖数据
- 对比分析搜索结果与历史数据
- 支持循环执行和智能错误恢复
- 详细的日志记录和状态监控
- 性能追踪和资源监控
- 错误分类和自动重试机制
- **OCR 自适应识别**：基于锚点定位，支持窗口移动和分辨率改变后自动适配

## 当前任务清单

1. ✅ 实现数据/API 模块：开奖 API 客户端、数据处理、号码对比能力
2. ✅ 串联 AppAutomator 与新模块，完善 dry run 与真实执行路径
3. ✅ 更新 README 与 progress 文档，补充测试/验证记录（迭代二定位桌面应用自动化）
4. ✅ 推进迭代二（桌面应用自动化与搜索功能）- 已完成核心模块开发（2025-11-22）
5. ✅ 校验迭代一内容更新并同步 progress 文档（2025-11-22）
6. ✅ 修复推荐号统计提取路径，新增控件正则/OCR/表格统计多层兜底（2025-11-22）
7. ✅ 增强开奖数据获取，支持HTML解析回退，等待API恢复（2025-11-23）
8. ✅ 完成迭代四：循环执行与错误处理优化（2025-11-23）
9. ✅ 确保循环执行仅对比最新开奖数据，避免重复对比旧期号（2025-11-23）
10. ✅ 完成 Supabase 推荐号写入链路与配置校验（2025-11-23）
11. ✅ 启动后自动置顶窗口并完善窗口展示配置（2025-11-23）
12. ✅ 调整 OCR 推荐号统计逻辑，确保识别完整 10 条推荐（2025-11-23）
13. ✅ 完成 Supabase 推荐/对比双写入与 UPSERT（2025-11-23）
14. ✅ 开奖获取切换为纯 OCR 模式，API 回退仅作为可选开关（2025-11-23）
15. ✅ 开奖 OCR 前自动置顶窗口，避免识别失败（2025-11-23）
16. ✅ 推荐区 OCR 支持全屏截图+锚点定位，提升鲁棒性（2025-11-23）
17. ✅ 修复 OCR 锚点坐标转换错误，确保区域裁剪正确（2025-11-23）
18. ✅ 增强搜索完成检测逻辑，添加详细日志，优化停止按钮检测（2025-11-23）
19. ✅ 推荐号 OCR 添加调试截图保存功能（2025-11-23）
20. ✅ 扩大 OCR 裁剪区域宽度至 250px，完整识别推荐号统计（2025-11-23）
21. ✅ 增强锚点关键字匹配鲁棒性，支持窗口移动和分辨率自适应（2025-11-23）
22. ✅ 改进搜索完成检测：监测停止按钮状态变化而非表格数据（2025-11-23）
23. ✅ 进一步扩大 OCR 区域至 280x550px，增强全量号码识别（2025-11-23）
24. ✅ 增强 OCR 调试日志：输出所有识别文本和解析过程（2025-11-23）
25. ✅ 开奖 OCR 基于窗口标题锁定句柄并整窗识别（2025-11-23）
26. ✅ 推荐区 OCR 支持 inner_offset_x 右移裁剪，去除左侧列表干扰（2025-11-23）
27. ✅ 提升推荐区 OCR 识别率：增加图像预处理和数字字符集限制（2025-11-23）
28. ⏳ 在 Supabase 上创建 recommendations 表并配置访问策略（待完成）
29. ✅ 修复窗口句柄误连“计划接口-奇趣腾讯分分彩”问题，稳定主窗口绑定并为推荐区 OCR 增加窗口尺寸校验与自动重连兜底（2025-11-23）

## 🚀 新电脑快速部署

**如果你是第一次在新电脑上部署本项目，请查看详细部署指南**：

📖 [新电脑部署指南](docs/deployment_guide.md)

该指南包含：
- ✅ 完整的环境准备步骤
- ✅ Python、Git、Tesseract OCR 安装教程
- ✅ 项目克隆和依赖安装
- ✅ 配置文件详细说明
- ✅ 常见问题解决方案
- ✅ 快速开始检查清单

---

## 系统要求

- Windows 10/11 操作系统（64位）
- Python 3.11 或更高版本
- Git（用于克隆项目）
- Tesseract OCR 5.0+（文字识别引擎）
- 奇趣腾讯分分彩桌面应用程序
- 至少 4GB RAM
- 至少 2GB 可用磁盘空间

## 安装步骤

1. 克隆或下载项目代码
2. 安装依赖包：
   ```
   pip install -r requirements.txt
   ```
3. 安装目标桌面应用（奇趣腾讯分分彩）
4. 配置 `config/config.json` 文件，设置必要的参数（特别是 `target_app.executable_path` 和 `target_app.window_title`）
5. 运行应用程序：
   ```
   python main.py
   ```

## 配置说明

应用程序的主要配置文件是 `config/config.json`，包含以下配置项：

- **目标应用配置**：应用名称、可执行文件路径、窗口标题等
- **搜索配置**：公式数量、数据期数、定码个数、准确率阈值、搜索超时等
- **API配置**：API地址、请求头、速率限制等
- **推荐数据配置**：推荐号码源文件路径、编码格式、最大记录数等
- **数据配置**：存储路径、缓存设置、保留天数等
- **日志配置**：日志级别、文件路径、滚动设置等
- **循环配置**：循环间隔、最大迭代次数、错误阈值等

## 使用说明

### 基本使用

1. 准备推荐号码源文件 `./data/recommendations.txt`：每行 5 个数字（0-9）组成的推荐号，空格或逗号分隔，支持以 `#` 开头的注释；工具按 `recommendation.max_records` 读取。
2. 启动应用程序：
   ```
   python main.py
   ```
3. 应用程序将自动执行以下步骤：
   - 启动目标应用（真实运行）或仅校验配置（dry-run）
   - 读取搜索参数、推荐号配置及 API 信息
   - 调用 `LotteryApiClient` 获取最新一期开奖号码
   - 使用 `RecommendationProcessor` 清洗推荐号并与开奖号码对比
   - 记录对比详情与命中情况至 `./data/results/comparison_history.jsonl` 与 `latest_comparison.json`
   - 输出日志，便于 dry-run/真实流程快速比对推荐与开奖结果

### 命令行参数

应用程序支持以下命令行参数：

- `--config`：指定配置文件路径
- `--headless`：启用无头模式（不显示浏览器窗口）
- `--loop`：启用循环执行模式
- `--interval`：设置循环执行间隔（秒）
- `--log-level`：设置日志级别（DEBUG, INFO, WARNING, ERROR）
- `--help`：显示帮助信息

示例：
```
python main.py --headless --loop --interval 600 --log-level DEBUG
```

### 配置文件示例

```json
{
  "app": {
    "name": "腾讯分分彩公式搜索自动化工具",
    "version": "1.0.0"
  },
  "browser": {
    "type": "chrome",
    "headless": false,
    "window_size": {
      "width": 1280,
      "height": 720
    }
  },
  "target_app": {
    "name": "奇趣腾讯分分彩",
    "executable_path": "C:\\path\\to\\app.exe"
  },
  "search": {
    "formula_count": 10,
    "data_periods": 100,
    "search_timeout": 300
  },
  "loop": {
    "enabled": true,
    "interval": 300,
    "max_iterations": 0
  }
}
```

## 项目结构

```
PC-Test/
├── main.py                     # 应用程序入口点
├── requirements.txt            # 项目依赖
├── README.md                   # 项目说明文档
├── CLAUDE.md                   # AI代理开发规则
├── config/                     # 配置文件目录
│   ├── settings.py            # 应用程序设置
│   └── config.json            # 配置文件
├── memory-bank/               # 项目记忆库
│   ├── game-design-document.md  # 项目设计文档
│   ├── tech-stack.md          # 技术栈文档
│   ├── implementation-plan.md  # 实施计划
│   ├── architecture.md        # 架构文档
│   └── progress.md            # 进度跟踪
├── src/                       # 源代码目录
│   ├── automator/             # 自动化模块
│   ├── data/                  # 数据处理模块
│   ├── api/                   # API接口模块
│   ├── exception/             # 异常处理模块
│   └── utils/                 # 工具模块
├── tests/                     # 测试目录
├── logs/                      # 日志目录
└── data/                      # 数据目录
```

## 开发指南

### 环境搭建

1. 安装 Python 3.8 或更高版本
2. 安装依赖包：`pip install -r requirements.txt`
3. 安装开发工具：`pip install -r requirements-dev.txt`（如果有）
4. 配置 IDE（推荐使用 PyCharm 或 VSCode）

### 代码规范

项目遵循以下代码规范：

- 使用 PEP 8 代码风格
- 使用 Black 进行代码格式化
- 使用 isort 进行导入排序
- 使用 flake8 进行代码检查
- 编写单元测试和集成测试

### 测试

运行测试：
```
pytest tests/
```

运行测试并生成覆盖率报告：
```
pytest --cov=src tests/
```

## 故障排除

### 常见问题

1. **浏览器启动失败**
   - 检查 ChromeDriver 是否正确安装
   - 确认 Chrome 浏览器版本与 ChromeDriver 版本匹配
   - 检查浏览器配置是否正确

2. **目标应用启动失败**
   - 检查应用路径是否正确
   - 确认应用是否已正确安装
   - 检查应用权限设置

3. **元素定位失败**
   - 检查应用界面是否有变化
   - 增加元素等待时间
   - 更新元素定位策略

4. **API请求失败**
   - 检查网络连接
   - 确认API地址和参数是否正确
   - 检查API访问限制

### 日志分析

应用程序会生成详细的日志记录，可以通过以下方式分析问题：

1. 查看 `logs/app.log` 文件
2. 根据日志级别过滤信息
3. 搜索错误和警告信息
4. 分析操作时间线和状态变化

## 贡献指南

欢迎提交问题报告和功能请求。如果您想贡献代码，请遵循以下步骤：

1. Fork 项目仓库
2. 创建功能分支：`git checkout -b feature/new-feature`
3. 提交更改：`git commit -am 'Add new feature'`
4. 推送分支：`git push origin feature/new-feature`
5. 提交拉取请求

## 许可证

本项目采用 MIT 许可证。详情请参阅 LICENSE 文件。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 邮箱：your-email@example.com
- 项目地址：https://github.com/your-username/pc-test

## 更新日志

### v1.2.0 (2025-11-23)

- ✅ 实现迭代四：循环执行与错误处理优化
- ✅ 新增 LoopExecutor：循环执行控制器，支持状态监控和统计
- ✅ 新增 ErrorRecoveryManager：错误恢复管理器，实现智能错误分类和自动恢复
- ✅ 新增 ResourceMonitor：资源监控器，实时监控CPU、内存等系统资源
- ✅ 新增 PerformanceTracker：性能追踪器，追踪和分析各操作的性能指标
- ✅ 增强主程序：整合所有监控和错误处理能力，提供完整的运行状态报告
- ✅ 支持指数退避重试策略和错误阈值控制
- ✅ 支持信号处理和优雅退出机制

### v1.1.0 (2025-11-22)

- ✅ 实现迭代二：桌面应用自动化功能
- ✅ 新增 WindowManager：负责窗口查找、连接和激活
- ✅ 新增 SearchConfigurator：负责配置搜索参数
- ✅ 新增 SearchExecutor：负责执行搜索和提取结果
- ✅ 集成 pywinauto 和 pyautogui 实现 Windows 桌面自动化
- ✅ 支持从桌面应用直接搜索公式并提取推荐号码
- ✅ 完善桌面自动化流程：连接窗口->配置参数->执行搜索->提取结果->对比分析

### v1.0.0 (2023-11-01)

- 初始版本发布
- 实现基本的自动化功能
- 支持搜索参数配置和结果提取
- 支持历史数据获取和对比分析
- 支持循环执行和错误恢复

---

**注意**：本工具仅供学习和研究使用，请遵守相关法律法规和使用条款。